generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model recuperacaoSenha {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  codigo    String   @db.VarChar(6)
  expira    DateTime
  usado     Boolean  @default(false)
  criadoEm  DateTime @default(now()) @map("criado_em")
  usuario   usuario  @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId], map: "recuperacao_senha_usuarioId_fkey")
  @@map("recuperacao_senha")
}

model categoria {
  id          Int       @id @default(autoincrement())
  nome        String    @unique
  descricao   String?   @db.Text
  icone       String?   @db.VarChar(50)
  preco_base  Decimal?  @db.Decimal(10, 2)
  tempo_medio Int?
  servicos    servico[]

  @@map("categoria")
}

model servico_parada {
  id               Int      @id @default(autoincrement())
  id_servico       Int
  ordem            Int      
  tipo             String   @db.VarChar(20) // 'origem', 'parada', 'destino'
  lat              Decimal  @db.Decimal(10, 8)
  lng              Decimal  @db.Decimal(11, 8)
  descricao        String?  @db.VarChar(255)
  endereco_completo String? // wndereço completo para exibição
  tempo_estimado_chegada Int? // tempo estimado para chegar nesta parada (em minutos)
  data_criacao     DateTime @default(now())

  servico servico @relation(fields: [id_servico], references: [id], onDelete: Cascade)

  @@map("servico_parada")
  @@index([id_servico])
  @@index([id_servico, ordem])
}

model servico {
  id               Int           @id @default(autoincrement())
  id_contratante   Int
  id_prestador     Int?
  id_categoria     Int?
  descricao        String
  status           statusServico @default(PENDENTE)
  data_solicitacao DateTime      @default(now())
  data_conclusao   DateTime?
  data_confirmacao DateTime?
  id_localizacao   Int?
  valor            Decimal?      @db.Decimal(10, 2)
  tempo_estimado   Int?          // em minutos
  data_inicio      DateTime?     // quando o prestador começou a se deslocar
  data_chegada     DateTime?     // quando o prestador chegou ao local
  pagamentos       pagamento[]
  notificacoes     notificacao[]
  rastreamentos    rastreamento_servico[]
  atualizacoes     atualizacao_tempo_real[]
  mensagens        chat_servico[]
  avaliacao        avaliacao[]
  paradas          servico_parada[]
  
  categoria        categoria?    @relation(fields: [id_categoria], references: [id])
  contratante      contratante   @relation(fields: [id_contratante], references: [id])
  localizacao      localizacao?  @relation(fields: [id_localizacao], references: [id])
  prestador        prestador?    @relation(fields: [id_prestador], references: [id])

  @@index([id_categoria], map: "servico_id_categoria_fkey")
  @@index([id_contratante], map: "servico_id_contratante_fkey")
  @@index([id_localizacao], map: "servico_id_localizacao_fkey")
  @@index([id_prestador], map: "servico_id_prestador_fkey")
  @@map("servico")
}

model rastreamento_servico {
  id          Int                 @id @default(autoincrement())
  id_servico  Int
  status      StatusRastreamento
  latitude    Decimal?
  longitude   Decimal?
  endereco    String?
  data_hora   DateTime            @default(now())
  observacao  String?             @db.Text
  
  servico     servico             @relation(fields: [id_servico], references: [id])
  
  @@index([id_servico])
  @@map("rastreamento_servico")
}

model atualizacao_tempo_real {
  id               Int               @id @default(autoincrement())
  id_servico       Int
  id_prestador     Int
  tipo             TipoAtualizacao
  latitude         Decimal?
  longitude        Decimal?
  mensagem         String?           @db.Text
  url_foto         String?
  data_criacao     DateTime          @default(now())
  
  servico          servico           @relation(fields: [id_servico], references: [id])
  prestador        prestador         @relation(fields: [id_prestador], references: [id])
  
  @@index([id_servico])
  @@index([id_prestador])
  @@map("atualizacao_tempo_real")
}

model chat_servico {
  id             Int       @id @default(autoincrement())
  id_servico     Int
  id_contratante Int
  id_prestador   Int
  mensagem       String    @db.Text
  tipo           String    // 'texto', 'imagem', 'localizacao'
  url_anexo      String?
  enviado_por    String    // 'contratante' ou 'prestador'
  lida           Boolean   @default(false)
  data_envio     DateTime  @default(now())
  
  servico        servico   @relation(fields: [id_servico], references: [id])
  contratante    contratante @relation(fields: [id_contratante], references: [id])
  prestador      prestador   @relation(fields: [id_prestador], references: [id])
  
  @@index([id_servico])
  @@index([id_contratante])
  @@index([id_prestador])
  @@map("chat_servico")
}

model notificacao {
  id           Int      @id @default(autoincrement())
  id_usuario   Int
  id_servico   Int?
  tipo         String   // 'servico', 'pagamento', 'sistema', 'mensagem'
  titulo       String
  mensagem     String
  lida         Boolean  @default(false)
  data_criacao DateTime @default(now())

  usuario      usuario  @relation(fields: [id_usuario], references: [id])
  servico      servico? @relation(fields: [id_servico], references: [id])

  @@map("notificacao")
}

model avaliacao {
  id             Int       @id @default(autoincrement())
  id_servico     Int       @unique
  id_contratante Int
  id_prestador   Int
  nota           Int
  comentario     String?   @db.Text
  data_avaliacao DateTime? @default(now())

  // ADICIONE ESTAS RELAÇÕES
  servico        servico     @relation(fields: [id_servico], references: [id])
  contratante    contratante @relation(fields: [id_contratante], references: [id])
  prestador      prestador   @relation(fields: [id_prestador], references: [id])

  @@index([id_contratante])
  @@index([id_prestador])
  @@map("avaliacao")
}

model pagamento {
  id             Int             @id @default(autoincrement())
  id_servico     Int
  id_contratante Int
  id_prestador   Int
  valor          Decimal         @db.Decimal(10, 2)
  metodo         metodoPagamento @default(CARTEIRA_PAGBANK)
  status         statusPagamento @default(PENDENTE)
  id_pagbank     String?
  data_pagamento DateTime        @default(now())
  contratante    contratante     @relation(fields: [id_contratante], references: [id])
  prestador      prestador       @relation(fields: [id_prestador], references: [id])
  servico        servico         @relation(fields: [id_servico], references: [id])

  @@index([id_contratante], map: "pagamento_id_contratante_fkey")
  @@index([id_prestador], map: "pagamento_id_prestador_fkey")
  @@index([id_servico], map: "pagamento_id_servico_fkey")
  @@map("pagamento")
}

model carteira {
  id            Int                 @id @default(autoincrement())
  id_usuario    Int                 @unique
  chave_pagbank String
  saldo         Decimal             @default(0.00) @db.Decimal(10, 2)
  data_criacao  DateTime            @default(now())
  usuario       usuario             @relation(fields: [id_usuario], references: [id])
  transacoes    transacaoCarteira[]

  @@map("carteira")
}

model transacaoCarteira {
  id             Int           @id @default(autoincrement())
  id_carteira    Int
  tipo           tipoTransacao
  valor          Decimal       @db.Decimal(10, 2)
  descricao      String?
  data_transacao DateTime      @default(now())
  carteira       carteira      @relation(fields: [id_carteira], references: [id])

  @@index([id_carteira], map: "transacao_carteira_id_carteira_fkey")
  @@map("transacao_carteira")
}

model localizacao {
  id          Int           @id @default(autoincrement())
  logradouro  String
  numero      String?
  bairro      String
  cidade      String
  cep         String?
  latitude    Decimal
  longitude   Decimal
  contratante contratante[]
  servicos    servico[]
  prestador   prestador[]   @relation("localizacaotoprestador")

  @@map("localizacao")
}

model contratante {
  id             Int                      @id @default(autoincrement())
  necessidade    contratante_necessidade?
  id_usuario     Int                      @unique(map: "Contratante_id_usuario_key")
  id_localizacao Int
  cpf            String?                  @unique(map: "Contratante_cpf_key")
  localizacao    localizacao              @relation(fields: [id_localizacao], references: [id], map: "Contratante_id_localizacao_fkey")
  usuario        usuario                  @relation(fields: [id_usuario], references: [id], map: "Contratante_id_usuario_fkey")
  pagamento      pagamento[]
  servico        servico[]
  mensagens      chat_servico[]
  avaliacao      avaliacao[]

  @@index([id_localizacao], map: "Contratante_id_localizacao_fkey")
}

model documento {
  id             Int                      @id @default(autoincrement())
  tipo_documento documento_tipo_documento
  valor          String
  data_validade  DateTime?
  arquivo_url    String?
  id_prestador   Int
  prestador      prestador                @relation(fields: [id_prestador], references: [id], map: "Documento_id_prestador_fkey")

  @@index([id_prestador], map: "Documento_id_prestador_fkey")
}

model prestador {
  id          Int           @id @default(autoincrement())
  id_usuario  Int           @unique(map: "Prestador_id_usuario_key")
  documento   documento[]
  pagamento   pagamento[]
  usuario     usuario       @relation(fields: [id_usuario], references: [id], map: "Prestador_id_usuario_fkey")
  servico     servico[]
  localizacao localizacao[] @relation("localizacaotoprestador")
  atualizacoes     atualizacao_tempo_real[]
  mensagens        chat_servico[]
  avaliacao        avaliacao[]

  @@index([id_usuario], map: "Prestador_id_usuario_idx")
}

model recarga_carteira {
  id             Int               @id @default(autoincrement())
  id_usuario     Int
  valor          Decimal           @db.Decimal(10, 2)
  metodo         MetodoRecarga     @default(PIX)
  status         StatusRecarga     @default(PENDENTE)
  id_pagbank     String?
  data_solicitacao DateTime        @default(now())
  data_confirmacao DateTime?
  usuario        usuario           @relation(fields: [id_usuario], references: [id])

  @@index([id_usuario])
  @@map("recarga_carteira")
}

model usuario {
  id           Int                 @id @default(autoincrement())
  nome         String
  senha_hash   String
  foto_perfil  String?             @db.VarChar(255)
  email        String              @unique(map: "Usuario_email_key")
  telefone     String              @unique(map: "Usuario_telefone_key")
  tipo_conta   usuario_tipo_conta?
  criado_em    DateTime            @default(now())
  carteira     carteira?
  contratante  contratante?
  prestador    prestador?
  recuperacoes recuperacaoSenha[]
  notificacoes notificacao[]
  recarga      recarga_carteira[]
}

enum statusServico {
  PENDENTE
  EM_ANDAMENTO
  FINALIZADO
  CANCELADO
}

enum metodoPagamento {
  CARTEIRA_PAGBANK
  PIX
  CARTAO
}

enum statusPagamento {
  PENDENTE
  PAGO
  FALHOU
  CANCELADO
}

enum tipoTransacao {
  ENTRADA
  SAIDA
}

enum documento_tipo_documento {
  RG
  CPF
  CNH_EAR
  TIPO_VEICULO
  MODELO_VEICULO
  ANO_VEICULO
}

enum contratante_necessidade {
  IDOSO
  DEF_VISUAL
  DEF_AUDITIVA
  DEF_MOTORA
  DEF_INTELECTUAL
  NENHUMA
}

enum usuario_tipo_conta {
  CONTRATANTE
  PRESTADOR
}

enum StatusRastreamento {
  A_CAMINHO
  CHEGOU_LOCAL
  INICIADO
  FINALIZADO
}

enum TipoAtualizacao {
  LOCALIZACAO
  STATUS
  MENSAGEM
  FOTO
}

enum MetodoRecarga {
  PIX
  CARTAO
  BOLETO
}

enum StatusRecarga {
  PENDENTE
  CONFIRMADA
  CANCELADA
  FALHOU
}